name: Render Documentary Video

# NOTE: GitHub-hosted runners (2-core) take ~3-5h for this render.
# Recommended: use a self-hosted runner with more cores, or render locally
# and upload the MP4 to the v1.0.0 release manually (see README).
# To use a self-hosted runner, add `runs-on: self-hosted` to the render job.

on:
  workflow_dispatch:
    inputs:
      concurrency:
        description: 'Rendering concurrency (tabs)'
        required: false
        default: '4'
      upload_release:
        description: 'Upload video to GitHub Release'
        required: false
        default: 'true'
        type: boolean

jobs:
  render:
    runs-on: ubuntu-latest
    timeout-minutes: 360   # 6h ceiling — render is ~30min on fast hardware

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: video/package-lock.json

      - name: Install dependencies
        working-directory: video
        run: npm ci

      # ── Audio assets ──────────────────────────────────────────────────────
      # The 216 narration WAV chunks and background music are stored in a
      # GitHub Release called "audio-assets" (too large for git).
      # We download and unpack them before rendering.

      - name: Download audio assets from release
        working-directory: video
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Fetching audio assets from release..."
          gh release download audio-assets \
            --repo ${{ github.repository }} \
            --pattern "audio-chunks.tar.gz" \
            --dir /tmp/audio-assets || echo "WARNING: audio-chunks.tar.gz not found in release"

          gh release download audio-assets \
            --repo ${{ github.repository }} \
            --pattern "bgm.wav" \
            --dir /tmp/audio-assets || echo "WARNING: bgm.wav not found in release"

      - name: Unpack audio chunks
        run: |
          mkdir -p video/public/audio/chunks
          if [ -f /tmp/audio-assets/audio-chunks.tar.gz ]; then
            tar -xzf /tmp/audio-assets/audio-chunks.tar.gz -C video/public/audio/chunks/
            echo "Unpacked $(ls video/public/audio/chunks/ | wc -l) chunk WAVs"
          else
            echo "No chunks archive found — render will use placeholder durations"
          fi
          if [ -f /tmp/audio-assets/bgm.wav ]; then
            cp /tmp/audio-assets/bgm.wav video/public/audio/bgm.wav
            echo "BGM audio ready"
          else
            echo "No BGM found — video will have no background music"
          fi

      # ── Install Chrome system dependencies for Remotion ──────────────────
      # Remotion downloads its own Chrome binary; we just need system libs.
      # libasound2 was renamed to libasound2t64 in Ubuntu 24.04.
      - name: Install Chrome system dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y \
            libgbm1 \
            libnss3 \
            libatk-bridge2.0-0 \
            libdrm2 \
            libxkbcommon0 \
            libxcomposite1 \
            libxdamage1 \
            libxrandr2 \
            libpango-1.0-0 \
            libcairo2 \
            fonts-liberation \
            --no-install-recommends
          # libasound2 renamed to libasound2t64 in Ubuntu 24.04
          sudo apt-get install -y libasound2t64 2>/dev/null || \
          sudo apt-get install -y libasound2 2>/dev/null || true

      - name: Ensure Remotion browser
        working-directory: video
        run: npx remotion browser ensure

      # ── Render ────────────────────────────────────────────────────────────
      - name: Render video
        working-directory: video
        run: |
          npx remotion render \
            src/index.ts \
            FertilityCrisis \
            out/FertilityCrisis.mp4 \
            --concurrency=${{ github.event.inputs.concurrency || '4' }} \
            --gl=swangle \
            --log=verbose
        env:
          NODE_OPTIONS: '--max-old-space-size=4096'

      - name: Verify output
        run: |
          ls -lh video/out/FertilityCrisis.mp4
          echo "Render complete."

      # ── Upload as artifact (always) ───────────────────────────────────────
      - name: Upload video artifact
        uses: actions/upload-artifact@v4
        with:
          name: FertilityCrisis-video
          path: video/out/FertilityCrisis.mp4
          retention-days: 30

      # ── Publish to GitHub Release ─────────────────────────────────────────
      # Always upload on push to main; respect the toggle on manual runs
      - name: Upload to GitHub Release
        if: ${{ github.event_name == 'push' || github.event.inputs.upload_release == 'true' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Upload to the latest semver release if one exists, otherwise create dated one
          LATEST=$(gh release list --repo ${{ github.repository }} --limit 1 \
            --json tagName --jq '.[0].tagName' 2>/dev/null || echo "")
          if [[ "$LATEST" == v* ]]; then
            TAG="$LATEST"
          else
            TAG="v$(date +'%Y.%m.%d')"
            gh release create "$TAG" \
              --repo ${{ github.repository }} \
              --title "The Male Fertility Crisis — Documentary $TAG" \
              --notes "Rendered documentary video. Generated by GitHub Actions." \
              --latest \
              2>/dev/null || true
          fi
          gh release upload "$TAG" video/out/FertilityCrisis.mp4 \
            --repo ${{ github.repository }} \
            --clobber
          echo "Video uploaded to release $TAG"
