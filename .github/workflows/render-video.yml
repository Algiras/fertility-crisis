name: Render Documentary Video

on:
  workflow_dispatch:
    inputs:
      concurrency:
        description: 'Rendering concurrency (tabs)'
        required: false
        default: '4'
      upload_release:
        description: 'Upload video to GitHub Release'
        required: false
        default: 'true'
        type: boolean

jobs:
  render:
    runs-on: ubuntu-latest
    timeout-minutes: 360   # 6h ceiling — render is ~30min on fast hardware

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: video/package-lock.json

      - name: Install dependencies
        working-directory: video
        run: npm ci

      # ── Audio assets ──────────────────────────────────────────────────────
      # The 216 narration WAV chunks and background music are stored in a
      # GitHub Release called "audio-assets" (too large for git).
      # We download and unpack them before rendering.

      - name: Download audio assets from release
        working-directory: video
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Fetching audio assets from release..."
          gh release download audio-assets \
            --repo ${{ github.repository }} \
            --pattern "audio-chunks.tar.gz" \
            --dir /tmp/audio-assets || echo "WARNING: audio-chunks.tar.gz not found in release"

          gh release download audio-assets \
            --repo ${{ github.repository }} \
            --pattern "bgm.wav" \
            --dir /tmp/audio-assets || echo "WARNING: bgm.wav not found in release"

      - name: Unpack audio chunks
        run: |
          mkdir -p video/public/audio/chunks
          if [ -f /tmp/audio-assets/audio-chunks.tar.gz ]; then
            tar -xzf /tmp/audio-assets/audio-chunks.tar.gz -C video/public/audio/chunks/
            echo "Unpacked $(ls video/public/audio/chunks/ | wc -l) chunk WAVs"
          else
            echo "No chunks archive found — render will use placeholder durations"
          fi
          if [ -f /tmp/audio-assets/bgm.wav ]; then
            cp /tmp/audio-assets/bgm.wav video/public/audio/bgm.wav
            echo "BGM audio ready"
          else
            echo "No BGM found — video will have no background music"
          fi

      # ── Install Chromium for Remotion ─────────────────────────────────────
      - name: Install Chromium dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y \
            chromium-browser \
            libgbm1 \
            libnss3 \
            libatk-bridge2.0-0 \
            libdrm2 \
            libxkbcommon0 \
            libxcomposite1 \
            libxdamage1 \
            libxrandr2 \
            libpango-1.0-0 \
            libcairo2 \
            libasound2 \
            fonts-liberation \
            --no-install-recommends

      # ── Render ────────────────────────────────────────────────────────────
      - name: Render video
        working-directory: video
        run: |
          npx remotion render \
            src/index.ts \
            FertilityCrisis \
            out/FertilityCrisis.mp4 \
            --concurrency=${{ github.event.inputs.concurrency || '4' }} \
            --gl=swangle \
            --log=verbose
        env:
          NODE_OPTIONS: '--max-old-space-size=4096'

      - name: Verify output
        run: |
          ls -lh video/out/FertilityCrisis.mp4
          echo "Render complete."

      # ── Upload as artifact (always) ───────────────────────────────────────
      - name: Upload video artifact
        uses: actions/upload-artifact@v4
        with:
          name: FertilityCrisis-video
          path: video/out/FertilityCrisis.mp4
          retention-days: 30

      # ── Optionally publish to GitHub Release ─────────────────────────────
      - name: Upload to GitHub Release
        if: ${{ github.event.inputs.upload_release == 'true' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="v$(date +'%Y.%m.%d')"
          # Create release if it doesn't exist for today
          gh release create "$TAG" \
            --repo ${{ github.repository }} \
            --title "The Male Fertility Crisis — Documentary $TAG" \
            --notes "Rendered documentary video. Generated by GitHub Actions." \
            --latest \
            2>/dev/null || true
          gh release upload "$TAG" video/out/FertilityCrisis.mp4 \
            --repo ${{ github.repository }} \
            --clobber
          echo "Video uploaded to release $TAG"
